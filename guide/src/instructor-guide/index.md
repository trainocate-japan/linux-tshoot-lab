# 講師向けガイド
- この資料やシェルスクリプトなどのソースコードは https://github.com/trainocate-japan/linux-tshoot-lab で管理しています
## コース概要
- Linuxで稼働しているシステムに発生するシステムトラブルの種類や対応できるコマンドの紹介や、システムトラブル対応の基礎を学ぶコースです
- コースは2日構成です。1日目はトラブル対応に関連する知識を学ぶ座学で、2日目はトラブル解決を実践する演習を行います
- 発生するトラブルのほとんどは実務で使えるLinux 入門編」を学んでいれば解決できる内容です（速習Linuxでも構いません） 
  - 一部、自己で検索が必要なトラブルも含まれます
  - 前提のコースで取り上げてないことは全て受講者向け資料で補足します 
## 演習概要 
- Red Hat系Linuxで稼動するWebシステムに発生したトラブルを解決し、システムの復旧作業を実践します
- webアプリケーションサーバーとDBサーバーに発生した複数のトラブルを修復する作業を通じて、実際の現場でのトラブル対応に近い体験ができます
- 演習での復旧作業のまとめとして、障害報告書を作成する時間を2日目の最後にとります

## 構成図
![構成図](./linuxintro-tshoot-structure-instructor.drawio.svg)
### 構成図解説
> わかもれなど、環境への接続については省略しています
- 1台のAWS EC2インスタンス(base-machie:Ubuntu) に、2台のホストからなるWebシステムを構成しています（構成構上の黄色箇所）
- Webシステムの他、作業端末用にもう一台ホストがあります（構成図右側の青塗りつぶし箇所）
- インスタンス内の各ホストはLXCコンテナで実現しています
  - EC2インスタンスはNestedVMに対応していないため、LXCコンテナを採用しました
- LXCコンテナ内のOSはAlmaLinux9です。今後変更の可能性はあります
- インスタンス内コンテナのネットワークアドレスは、受講者ごとに異なる可能性があります
- 構成図上の左側にあるNginx（ねずみ色箇所）はリバースプロキシとして稼動させています。詳細は後述します
- 受講者向け構成図は、LXCコンテナなどを省いた簡略版（演習に必要な情報のみ）を展開します。ただし、興味のある受講者向けに詳細構成図やLXCの解説などを付録として記載する予定です
### 構成詳細
- ログインのための認証情報は構成図に記載があります
#### Base-Machine
- Ubuntu 24.02
- 演習環境のベースとなるホストです。Ubuntuを採用した意図としては、LXCが使いやすいことと、作業環境ではないことをすぐに気づけるようにするためです
- Base-Machine上では、Nginxの復旧を除きトラブルシューティング作業は行いません
- Ubuntuのシェルを使っていることが分かるように、シェルのプロンプトを変更しています
#### Appコンテナ
- Alma Linux 9
- Apache HTTP Server
- Linux個人演習のWebアプリを流用
- 後述のNginxをWebサーバーとしているため、Appサーバーと名前を変えてますがあまり意味はありません
#### DBコンテナ
- Alma Linux 9
- MariaDB
- Linux個人演習のWebアプリを流用
#### 作業端末
- Alma Linux 9
- 受講者はUbuntuからこちらにログインし、トラブルシュート作業を行う
#### nginx
- Ubuntu上で直接稼働するサービス 
- Webサーバーにインスタンス外部からの接続をルーティングするために使用
- もう一つ、netdata（負荷計測用。後述）のユーザー認証のためにも使用しています
  - インターネットにポートを開放しているため、Basic認証をかけるためです
#### Netdata
- UbuntuやLXCコンテナの負荷計測用に、Netdataというオープンソースの監視ソフトウェアをUbuntu上で動作させています
  - Dockerを使っていますが、受講者はそれを意識する必要はありません
- Netdataで情報を見るためにはBasic認証をする必要があります。認証情報は構成図に記載してあります（user1/password） 
- サーバーが高負荷状態に陥っているので修正せよ、という意図のトラブルを仕込む予定のために配置しています

## 発生するトラブルについて
### Appコンテナ
#### Apacheサービスを停止
- stopするだけなので、systemctl startで復旧できます
#### /etc/httpd/conf/httpd.confのDocumentrootがシンタックスエラー
- /var/log/mariadb/mariadb.logを閲覧すればシンタックスエラーが出ているので気づけるはずです
#### systemctl enable されておらず、自動起動しない
- 復旧確認後に動作確認としてコンテナをリブートするように指示するので、そこで再び障害となります。もちろんすでに修正済みの場合は何も起きません
### MariaDBコンテナ
#### MariaDBサービスを停止
- stopするだけなので、systemctl startで復旧できます
#### ip link set eth0 down を実行
- リンクダウン障害を起こします。これとストレージ問題を解決しないとMariaDBは起動できません
- DBコンテナにSSHログインできなくなるため 、コンソールログイン用のLXCコマンドが必要になります。 リンクダウン障害や復旧方法も含めて、受講者向けのWeb資料にヒントとして記載します
- このトラブルは受講者ホストに入っている init.sh で実行されます（講師からはででコントロできません）
#### ストレージの消費量が100%になっている
- ddコマンドで無駄なファイルを生成しストレージの残りが0%になっており、MariaDBのstartができなくなってます
- /var/log/mariadb/mariadb.logを閲覧すればストレージ不足のエラーが出ているので気づけるはずです
- 無駄なファイルがどこにあるかを探すコマンドは受講者ガイドにヒントとして記載します
- このトラブルは受講者ホストに入っている init.sh で実行されます（講師からはででコントロできません）
### Nginxサービスを停止
- Appサーバーまでは復旧して内部的にwebページを参照できるがインターネットからは見れない、という状態です。復旧確認として、Ubuntuからページを見るためのcurlコマンドを受講者向けガイドには記載します
	- Ubuntu上でコマンドを発行することになりますがsystemctlだけなので実施できると想定しています
- Nginxが落ちている間はブラウザアクセスができないので、Netdataへのアクセスも出来ないはずです。なので、AppコンテナのCPU高騰に気づくのはこのタイミングだと思います

## 講師用端末について
- トラブル発生の捜査や、受講者Weサイトの復旧を確認するための講師用端末を用意しています。演習中はログインしておいてください
- ログイン方法は受講者同様、わかもれです
- 以下に詳細を記載します
### linux-tshoot-instructor-machine（講師用端末・構成図外）
- SessionManagerでログイン後、su - ec2-user (pasword)
```
[ec2-user@ip-10-0-128-136 ~]$ tree -L 2 .
.
├── checker.sh
├── public-address-getter.sh
├── repaierman-on-instructor-machine.sh
├── trouble-maker-on-instructor-machine.sh
└── urls.csv
```

#### 外形監視（受講者Weサイトの状態確認）
- public-address-getter.sh で、受講者WebサイトのURLを urls.csvに保存します
- checker.sh urls.csv を実行すると、受講者Webサイトの接続可否が表示されます

#### トラブル発生と修復
- Amazon SSM のRunCommandを使って受講者ホストにトラブルを起こします
- trouble-maker-on-instructor-machine.sh で、受講者環境にトラブルを発生させます。DBコンテナのストレージ圧迫とNICダウンは自動化するとまれに実施できないインスタンスがあるため、受講者ホストにあるinit.shに分離し、受講者自身に実施してもらうことにしてます
  - 実行後にCommandIDが表示されるので、進捗確認にお使いください
- repaierman-on-instructor-machine.shを実行すると全受講者のWebサイトが復旧します

## トラブルの発生方法について
- AWSの運用サービスであるSSM RunCommandを使って、インスタンスの外部から以下のシェルスクリプトを注入して実行します
  - 講師用端末にスクリプトを配置するので、AWSコンソールへのログインは不要です 
- 受講者端末のURLを監視するシェルスクリプトを配置します。watchコマンドと合わせて実行すると、どのURLが復旧しているのかがリアルタイムでわかります
- 受講者の作業が完了しているかの確認は、testinfra（Python製の構成確認ツール）を使う予定です。受講者ホストのアドレスを指定すればtestinfraが設定の自動チェックをかけるので講師が逐一チェックする必要はありません（の予定）

## コースの進め方
### オリエンテーション
- 30-40min
- 演習の説明
- 演習環境の解説、ログイン方法
  - 以前から利用しているわかもれなので皆さん覚えているはずですが、講師からのデモがあるとよいと思います
- トラブル発生タイミングのお知らせ
  - 11:10の全体休憩後に、講師の手によりトラブルが発生します
- 質疑応答
### 現状把握
- 20-30min
- インターネットからのアクセスを試す
- Netdataの監視状況をメモ
  - スクリーンキャプチャでもよい
- IPアドレスの記録、構成図をみながら各サーバーへのログインなどを試す
- 質疑応答
  - 構成について聞かれると思います
- 現状把握が終わったら、各自で `init.sh` を実行してもらいます（ホームディレクトリにあります）。初期化するように見せかけて実は、DBコンテナのストレージ圧迫とリンクダウンを行います（前述のとおり、自動化処理から行おうとするとまれに失敗することがあるためです）
### トラブル発生
- 11:10になったらトラブルを発生させます（init.shの実行によりすでにDBにはトラブルの起きてる方も多いと思います）
- トラブル発生には`trouble-maker-on-instructor-machine.sh`を実行してください。進捗は`aws ssm list-commands --command-id コマンドID`でも見れますが、見にくいです。大体3分程度で終了します。なので受講者には、3分ほどの待ち時間が発生することもお伝えください。休憩前に、休憩中にトラブルが発生することを伝えて、先に実行しても良いかもしれません
- GUIでの進捗確認は、待機しているAWS担当者に依頼してください
- トラブルが発生すると、外形監視が全てダウンするはずです
### トラブルシューティング
- 15:00過ぎまで
- この間は、トラブル解決手法以外の質問には回答してください。トラブル解決の方法を答える必要はありません
#### 復旧完了連絡の対応
- トラブルが解決したら講師に連絡することになっています。受講者から連絡があったら、以下を確認してください
  - 受講者ホストのURL監視が復旧していること
  - testinfraを実行してトラブル発生箇所の修正が全て完了していること
- 完了した受講者には、再発防止策の策定と、障害報告書の作成を指示してください。書き方は受講者資料に記載してあります
### 障害報告書の提出
- UMUのアンケートで提出します。これをもって演習は終了です
- 記載する内容は受講者向け資料で指示しますが、テキスト形式でのフリーフォーマットです
- 個別での評価は不要ですが、あまりに内容が薄いものやふざけているものがあれば修正を指示してください
- 書きかけで時間切れとなった場合はそこまでを提出してもらって終了です

### 解説用資料
- UMUでいうと障害報告書作成のあとに、解説用のPDFを記載しています。発生していたトラブルの解説や障害報告書のサンプルなどです
- この資料を元に解説するかは進行に応じてお任せしますが、余裕があれば16時半くらいから解説の時間を設けてもいいと思います。トラブル解消の答えも載っていますので、あまり早めの案内は避けてください

## その他
- 受講者ホストでは、ec2-user（作業用のユーザー）での sudo reboot は出来ないように制限しています。が、sudo su - でrootになったあとのリブートは制限していません。リブートしても放置すればまたわかもれからログイン出来ますので、もしリブートしてしまったという連絡があったら、3分ほどまってわかもれのログインから再開するようお伝えください
  - これは単純に制限しわすれです、、、今からVM焼き直すのが大変なので放置します、、、すみません
  - リブートしてもトラブルは解決しません（以前は解決するとお伝えしてましたがしないようにしました）
- CPU使用率高騰のトラブルは今回除外しました。トラブル発生用のスクリプトからだと上手く動作しないためです。今後の課題にします

## AWSおよびわかもれ環境ついて
- 以降は、主にAWSのサポートで待機しているメンバー向けの情報です。後日ちゃんと整理しますね、、、
### AWS上のリソース
#### 起動テンプレート(受講者ホスト)
- linux-tshoot-newtrain2025
- ユーザーデータでnetdataコンテナの起動とinit.shの設定をしてます
#### 講師用ホストAMI
- linux-tshoot-instructor-machine.v250802.01
- 頻繁に起動するわけではないので、起動テンプレートはありません
### わかもれ（Apache Guacamole）
- asg guacamole-app-asg
- rds guacamole-app-db
- RDSへの接続情報は、上記ASGで起動するインスタンスの/opt/guacamole/docker-compose.ymlに記載してます。RDSを変えない限りは気にしなくてよいです
- リソースグループ bastion-guacamole
  - Application Insightで監視できます

---
sidebar: auto
---

講師向けガイド
==

- この資料やシェルスクリプトなどのソースコードは [github:linux-tshoot-lab](https://github.com/trainocate-japan/linux-tshoot-lab) で管理しています
## コース概要
- Linuxで稼働しているシステムに発生するシステムトラブルの種類や対応できるコマンドの紹介や、システムトラブル対応の基礎を学ぶコースです
- コースは2日構成です。1日目はトラブル対応に関連する知識を学ぶ座学で、2日目はトラブル解決を実践する演習を行います
- 発生するトラブルのほとんどは実務で使えるLinux 入門編」を学んでいれば解決できる内容です（速習Linuxでも構いません） 
  - 一部、自己で検索が必要なトラブルも含まれます
  - 前提のコースで取り上げてないことは全て受講者向け資料で補足します 
## 演習概要 
- Red Hat系Linuxで稼動するWebシステムに発生したトラブルを解決し、システムの復旧作業を実践します
- webアプリケーションサーバーとDBサーバーに発生した複数のトラブルを修復する作業を通じて、実際の現場でのトラブル対応に近い体験ができます
- 演習での復旧作業のまとめとして、障害報告書を作成する時間を2日目の最後にとります

## 構成図
![構成図](./linuxintro-tshoot-structure-instructor.drawio.svg)
### 構成図解説
> わかもれなど、環境への接続については省略しています
- 1台のAWS EC2インスタンス(base-machie:Ubuntu) に、2台のホストからなるWebシステムを構成しています（構成構上の黄色箇所）
- Webシステムの他、作業端末用にもう一台ホストがあります（構成図右側の青塗りつぶし箇所）
- インスタンス内の各ホストはLXCコンテナで実現しています
  - EC2インスタンスはNestedVMに対応していないため、LXCコンテナを採用しました
- LXCコンテナ内のOSはAlmaLinux9です。今後変更の可能性はあります
- インスタンス内コンテナのネットワークアドレスは、受講者ごとに異なる可能性があります
- 構成図上の左側にあるNginx（ねずみ色箇所）はリバースプロキシとして稼動させています。詳細は後述します
- 受講者向け構成図は、LXCコンテナなどを省いた簡略版（演習に必要な情報のみ）を展開します。ただし、興味のある受講者向けに詳細構成図やLXCの解説などを付録として記載する予定です
### 構成詳細
- ログインのための認証情報は構成図に記載があります
- ログインはlxcコマンドを使ったログイン（コンソール接続のような感じ）のほか、通常のSSHも可能です
#### Base-Machine
- Ubuntu 24.02
- 演習環境のベースとなるホストです。Ubuntuを採用した意図としては、LXCが使いやすいことと、作業環境ではないことをすぐに気づけるようにするためです
- Base-Machine上では、Nginxの復旧を除きトラブルシューティング作業は行いません
- Ubuntuのシェルを使っていることが分かるように、シェルのプロンプトを変更しています
- わかもれから受講者マシンと同じ方法でログインするほか、AWSマネコンからSessionManagerでも接続できます
#### appコンテナ
- Alma Linux 9
- Apache HTTP Serverが稼働
- Linux個人演習のWebアプリを流用
- 後述のNginxをWebサーバーとしているため、appサーバーと名前を変えてますがあまり意味はありません
- base-machineから、`lxc exec app bash` でログインできます
#### dbコンテナ
- Alma Linux 9
- MariaDB
- Linux個人演習のWebアプリを流用
- base-machineから、`lxc exec db bash` でログインできます
#### 作業端末
- Alma Linux 9
- 受講者はUbuntuからこちらにログインし、トラブルシュート作業を行う
- base-machineから、`lxc exec workspace bash` でログインできます
#### nginx
- Ubuntu上で直接稼働するサービス 
- Webサーバーにインスタンス外部からの接続をルーティングするために使用
- もう一つ、netdata（負荷計測用。後述）のユーザー認証のためにも使用しています
  - インターネットにポートを開放しているため、Basic認証をかけるためです
#### Netdata
- UbuntuやLXCコンテナの負荷計測用に、Netdataというオープンソースの監視ソフトウェアをUbuntu上で動作させています
  - Dockerを使っていますが、受講者はそれを意識する必要はありません
- Netdataで情報を見るためにはBasic認証をする必要があります。認証情報は構成図に記載してあります（user1/password） 
- 今回は負荷系のトラブルはありませんが、監視ダッシュボードを見るのはトラブルシュート時に必須な作業のために設置してます

## 発生するトラブルについて
### appコンテナ
#### Apacheサービスを停止
- stopするだけなので、systemctl startで復旧できます
#### /etc/httpd/conf/httpd.confのDocumentrootがシンタックスエラー
- /var/log/mariadb/mariadb.logを閲覧すればシンタックスエラーが出ているので気づけるはずです
#### systemctl enable されておらず、自動起動しない
- 復旧確認後に動作確認としてコンテナをリブートするように指示するので、そこで再び障害となります。もちろんすでに修正済みの場合は何も起きません
### MariaDBコンテナ
#### MariaDBサービス
- stopするだけなので、systemctl startで復旧できます
#### ip link set eth0 down を実行
- リンクダウン障害を起こします。これとストレージ問題を解決しないとMariaDBは起動できません
- DBコンテナにSSHログインできなくなるため 、コンソールログイン用のLXCコマンドが必要になります。 リンクダウン障害や復旧方法も含めて、受講者向けのWeb資料にヒントとして記載します
- このトラブルは受講者ホストに入っている init.sh で実行されます（講師からはででコントロできません）
#### ストレージの消費量が100%になっている
- ddコマンドで無駄なファイルを生成しストレージの残りが0%になっており、MariaDBのstartができなくなってます
- /var/log/mariadb/mariadb.logを閲覧すればストレージ不足のエラーが出ているので気づけるはずです
- 無駄なファイルがどこにあるかを探すコマンドは受講者ガイドにヒントとして記載します
- このトラブルは受講者ホストに入っている init.sh で実行されます（講師からは実行しません）
### Nginxサービス（base-machine）
- appサーバーまでは復旧して内部的にwebページを参照できるがインターネットからは見れない、という状態です。復旧確認として、Ubuntuからページを見るためのcurlコマンドを受講者向けガイドには記載します
	- Ubuntu上でコマンドを発行することになりますがsystemctlだけなので実施できると想定しています
- Nginxが落ちている間はブラウザアクセスができないので、Netdataへのアクセスも出来ないはずです。なので、appコンテナのCPU高騰に気づくのはこのタイミングだと思います

## 講師用端末について
- トラブル発生の捜査や、受講者Weサイトの復旧を確認するための講師用端末を用意しています。演習中はログインしておいてください
- ログイン方法は受講者同様、わかもれです。わかもれの認証情報は別途展開しています。わかもれのあとは、受講者と同じ、ec2-user/passwordでログインできます
- 以下に詳細を記載します
### linux-tshoot-instructor-machine（講師用端末・構成図外）
- SessionManagerでログイン後、su - ec2-user (pasword)
```
[ec2-user@ip-10-0-128-136 ~]$ tree -L 2 .
.
├── checker.sh
├── public-address-getter.sh
├── repaierman-on-instructor-machine.sh
├── trouble-maker-on-instructor-machine.sh
└── urls.csv
```
#### 外形監視（受講者Weサイトの状態確認）
- public-address-getter.sh で、受講者WebサイトのURLを urls.csvに保存します
- checker.sh urls.csv を実行すると、受講者Webサイトの接続可否が表示されます
#### トラブル発生と修復
- Amazon SSM のRunCommandを使って受講者ホストにトラブルを起こします
- trouble-maker-on-instructor-machine.sh で、受講者環境にトラブルを発生させます。DBコンテナのストレージ圧迫とNICダウンは自動化するとまれに実施できないインスタンスがあるため、受講者ホストにあるinit.shに分離し、受講者自身に実施してもらうことにしてます
  - 実行後にCommandIDが表示されるので、進捗確認にお使いください
- repaierman-on-instructor-machine.shを実行すると全受講者のWebサイトが復旧します

## トラブルの発生方法について
- 2段階に分かれています。流れは後述の「コースの進め方」を参考にしてください
1. AWSの運用サービスであるSSM RunCommandを使って、インスタンスの外部から以下のシェルスクリプトを注入して実行します
  - 講師用端末にスクリプトを配置するので、AWSコンソールへのログインは不要です
  - trouble-maker-on-instructor-machine.sh
  ```shell
  #!/bin/sh
  aws ssm send-command \
    --document-name "AWS-RunShellScript" \
    --region ap-northeast-1 \
    --targets Key=resource-groups:Name,Values=linux-tshoot-targets \
    --parameters commands=["sudo systemctl stop nginx","lxc exec app -- sudo systemctl stop httpd","lxc exec app -- sudo systemctl disable httpd","lxc exec app -- sudo sed -i s/^DocumentRoot/ocumentRoot/ /etc/httpd/conf/httpd.conf","lxc exec db -- sudo systemctl stop mariadb","lxc exec db -- sudo systemctl disable mariadb"] \
    --output json|jq -r '.Command.CommandId'
  ```
2. base-machineのホームディレクトリにある init.sh を実行してもらいます。dbコンテナのリンクダウンとストレージ圧迫を行います
  - init.sh（内部でdb.shを呼び出している）
  ```shell
  #!/bin/sh
  rm -rf ./linux-tshoot-lab
  git clone https://github.com/trainocate-japan/linux-tshoot-lab.git
  sh linux-tshoot-lab/lab/bin/db.sh
  ``` 
  - db.sh（dbコンテナ内でストレージ圧迫とリンクダウンを発生）
  ```shell
  #!/bin/sh
  lxc exec db -- sudo dd if=/dev/random of=/var/log/mudana-file.img bs=1M count=3750 2> /dev/null &
  lxc exec db -- sudo ip link set eth0 down
  ```
- 1と2の実行順番はどちらでも構いません。流れとしては、現状把握の最後に各自のタイミングでinit.shを実行してもらい、その後休憩明けに講師がtrouble-makerを実行する、としています
  - init.shはストレージに負荷がかかるため、一斉実行するともしかするとうまく実行できないbase-machineが出てくるかもです。その場合は予備機に変えてもらった方が無難です。予備機については後述します
- ちなみに、、、ストレージ圧迫はddコマンドを利用していますが、大量のインスタンスが同時に実行するとどこかで処理が詰まるのか、失敗するインスタンスがいくつか出てきます。なので実行タイミングがばらけるように、講師からの実施ではなく受講者にタイミングを委ねることにしました
- 勘のいい受講者さんには早く気づかれるかもです。そこはまぁよしとしましょうw

## コースの進め方
### オリエンテーション
- 30-40min
- 演習の説明
- 演習環境の解説、ログイン方法
  - 以前から利用しているわかもれなので皆さん覚えているはずですが、講師からのデモがあるとよいと思います
- トラブル発生タイミングのお知らせ
  - 11:10の全体休憩後に、講師の手によりトラブルが発生します
- 質疑応答
### 現状把握
- 20-30min
- get-public-hostname.shを動かしてURLやプライベートアドレスを把握
- インターネットからのアクセスを試す
- Netdataの監視状況をメモ
  - スクリーンキャプチャでもよい
- IPアドレスの記録、構成図をみながら各サーバーへのログインなどを試す
- 質疑応答
  - 構成について聞かれると思います
- 現状把握が終わったら、各自で `init.sh` を実行してもらいます（base-machineのホームディレクトリにあります）。初期化するように見せかけて実は、DBコンテナのストレージ圧迫とリンクダウンを行います（前述のとおり、自動化処理から行おうとするとまれに失敗することがあるためです）
### トラブル発生
- 一斉休憩後の 11:10 になったらトラブルを発生させます（init.shの実行によりすでにDBにはトラブルの起きてる方も多いと思います）
- トラブル発生には`trouble-maker-on-instructor-machine.sh`を実行してください。進捗は`aws ssm list-commands --command-id コマンドID`でも見れますが、見にくいです。大体3分程度で終了します。なので受講者には、3分ほどの待ち時間が発生することもお伝えください。休憩前に、休憩中にトラブルが発生することを伝えて、先に実行しても良いかもしれません
- GUIでの進捗確認は、待機しているAWS担当者に依頼してください
- トラブルが発生すると、外形監視が全てダウンするはずです
### トラブルシューティング
- 15:00過ぎまで
- この間は、トラブル解決手法以外の質問には回答してください。トラブル解決の方法を答える必要はありません
- 外形監視を定期的に確認して、早く終わっている受講者がいるかをチェックしておいてください
- 受講者のわかもれアカウント・base-machineのプライベートアドレスの一覧は事前にお渡しします。受講者から問い合わせるときはプライベートアドレスを申告してもらいます。講師からは、そのアドレスに対して ec2-user/password でsshログインができます。基本的にログインする必要はありませんが、init.shの失敗の確認時には必要になるかも知れません
#### 復旧完了連絡の対応
- トラブルが解決したら講師に連絡することになっています。受講者から連絡があったら、以下を確認してください
  - 受講者ホストのURL監視が復旧していること
  - testinfraを実行してトラブル発生箇所の修正が全て完了していること
- 完了した受講者には、再発防止策の策定と、障害報告書の作成を指示してください。書き方は受講者資料に記載してあります
### 障害報告書の提出
- UMUのアンケートで提出します。これをもって演習は終了です
- 記載する内容は受講者向け資料で指示しますが、テキスト形式でのフリーフォーマットです
- 個別での評価は不要ですが、あまりに内容が薄いものやふざけているものがあれば修正を指示してください
- 書きかけで時間切れとなった場合はそこまでを提出してもらって終了です
- URL監視や報告などで想定より早くトラブルを解決してしまった受講者には、障害報告書を書く時間を長めにとってもらってください
### 解説用資料
- UMUでいうと障害報告書作成のあとに、解説用のPDFを記載しています。発生していたトラブルの解説や障害報告書のサンプルなどです
- この資料を元に解説するかは進行に応じてお任せしますが、余裕があれば16時半くらいから解説の時間を設けてもいいと思います。トラブル解消の答えも載っていますので、あまり早めの案内は避けてください

## 予備機について
- init.shの失敗に備えて、予備機を15台ほど用意します（yobi001-015）
- あらかじめトラブルを起こしておきます。コンテナのアドレスなど現状把握で得られた情報はそのまま使えるはずです
- 予備機を使うかどうかの判断は、ストレージ圧迫に失敗してるかどうか、が基本です。確認方法は以下なのですが、受講者さん自身が気づいてないことが多いかもしれません
  - lxc exec db bash でログインしたあと、ログアウトができない
  - base-machine上で `ps aux|grep dd` すると、ddコマンドでのファイル生成プロセスの状態が「D」のまま、数分進歩しない
- 演習がかなり進んだ後に、特にdbコンテナの動きがおかしい、という申告があったら予備機を提供してもいいと思います。それまでのトラブル対応の内容は記録するか覚えているはずなので、リカバリにそんなに時間はかからないはずです
- トラブルシューティングのコースのため、受講者が予備機を望んだ際の状況確認は詳細に行ってください。業務で必要になる状況説明の練習にもなると思います。受講者の中には、演習のために仕込まれたトラブルなのか、本当に環境の具合が悪いのかを判断できない方もいると思います

## その他
- 受講者ホストでは、ec2-user（作業用のユーザー）での sudo reboot は出来ないように制限しています。が、sudo su - でrootになったあとのリブートは制限していません。リブートしても放置すればまたわかもれからログイン出来ますので、もしリブートしてしまったという連絡があったら、3分ほどまってわかもれのログインから再開するようお伝えください
  - これは単純に制限しわすれです、、、今からVM焼き直すのが大変なので放置します、、、すみません
  - リブートしてもトラブルは解決しません（以前は解決するとお伝えしてましたがしないようにしました）
- CPU使用率高騰のトラブルは今回除外しました。トラブル発生用のスクリプトからだと上手く動作しないためです。今後の課題にします

## AWSおよびわかもれ環境ついて
- 以降は、主にAWSのサポートで待機しているメンバー向けの情報です。後日ちゃんと整理しますね、、、
### AWS上のリソース
#### 起動テンプレート(受講者ホスト)
- linux-tshoot-newtrain2025
- ユーザーデータでnetdataコンテナの起動とinit.shの設定をしてます
#### 講師用ホストAMI
- linux-tshoot-instructor-machine.v250802.01
- 頻繁に起動するわけではないので、起動テンプレートはありません
### わかもれ（Apache Guacamole）
- asg guacamole-app-asg
- rds guacamole-app-db
- RDSへの接続情報は、上記ASGで起動するインスタンスの/opt/guacamole/docker-compose.ymlに記載してます。RDSを変えない限りは気にしなくてよいです
- リソースグループ bastion-guacamole
  - application Insightで監視できます
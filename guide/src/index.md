---
sidebar: auto
---

演習ガイド
==
###### v25.08.04.1-dev
## I. 演習の前に
- この演習は、Linuxで稼働するWebアプリケーションシステム（以下、Webサイト）に発生したトラブルの解決（トラブルシューティング）を実践する演習です。明確な手順は用意されていないため、実務で発生するトラブルとその解決作業と同様、Linuxコマンドを駆使して手探りでの対応が必要となります
- トラブルシューティングを実践するだけでなく、実務で必要になる障害報告書の作成まで行って頂きます
### 注意事項
- トラブルシューティングを実践するコースであるため、具体的なトラブルの解決方法（コマンドなど）を受講者間で教え合うことは禁止します。進捗の良い方は、相談を受けたらヒントだけを伝えるようにしてください
- トラブルシューティング中には、該当のサーバーにログインできなかったりサーバーからの応答がない、という、通常の演習とは異なる挙動が見られることがあります。講師に相談する際は、その事象が演習の課題によるものなのか、それとも演習環境自体の不具合なのかを説明できるようにしましょう
### 演習環境へのログイン方法
> 実務で使えるLinux 入門編と同じです
- 講師（もしくは研修システム）から案内のあった「演習環境への接続情報」で、以下を確認してください
    - 接続先サイト
    - ユーザー名（各自のメールアドレス）
    - パスワード
- 「接続先サイト」へブラウザからアクセスし、ユーザー名（各自のメールアドレス）とパスワードを入力してログインしてください
- しばらく待つと「Login as: 」と聞かれるので、`ec2-user`と入力してください
- 続けて「Password:」と聞かれるので、`password`と入力してください
- 以下のようなメッセージが表示されれば、演習環境へのログインは完了です
```
Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.14.0-1010-aws x86_64)
（中略）
ec2-user@ip-X-X-X-X:~ -THISISNOTWORKSPACE- $ 
```
## II. 演習の流れ
- 演習は、以下の流れで進みます
### 1. オリエンテーション
- 演習の概要や目的、環境の説明を 講師から行います。展開される内容は、基本的に本資料に基づきます
### 2. 現状把握
- トラブル発生の前に、現在のWebシステムの構成を調べる時間です。トラブルシューティングをスムースに進められるようにしておきましょう。現状把握の開始タイミングは講師（もしくは研修システム）から指示があります。指示があり次第、後述の「現状把握で実施すること」を確認しながら進めてください
### 3.トラブルシューティング実践
- いよいよトラブルシューティングの実践です。前日の座学やこれまで学んできたことを活かして、トラブルを排除しシステムを復旧させましょう。後述の「トラブルシューティングの実践」を見ながら効率よく進めましょう
### 4. 障害報告書作成
- 演習の最後に、トラブルシューティングの記録を報告書に残します。後述の「障害報告書の作成」を見ながら作成してください

## III. 現状把握で実施すること
### 1. 構成図の確認
- 構構成に記載されている要素を確認します。これは実務でも同じです。構成図の各要素には番号が振られていますので、以下の説明と合わせて全貌を把握しておきましょう
- 
![](./linuxintro-tshoot-structure-student.drawio.svg)
#### 1) 受講者PC
- 皆さんの手元にあるPCです。演習の実施、ブラウザでのWebサイトの動作確認などに利用します
#### 2) ベースマシン（演習環境）
- ログインしたマシンです。クラウド上の仮想マシンで、演習環境はこの中に構築されています
- Linuxディストリビューションは Ubuntu 24.02 です
- 後述のwebサーバーはこのベースマシン上で動作しています
- コマンドプロンプトが`ec2-user@ip-X-X-X-X:~ -THISISNOTWORKSPACE- $`となっているのが目印です。また、Linuxディストリビューションが「Ubuntu」であるため、これまでの研修で利用していたRed hat系とはコマンド体系が少しことなりますのでご注意ください
- ベースマシンからはインターネットに接続できるので、ソフトウェアのインストールも可能です。ただしディストリビューションが Ubuntu なため、Red Hat系のyum/dnf ではなく apt を使います。ネットなどで調査して使ってください

::: warning
インストールするソフトウェアは、Ubuntuの標準リポジトリから追加される標準のものに限ります。また、GUIのツールのインストールはできません
:::

#### 3) 作業端末（workspace）
- 後述のappサーバーやdbサーバーにSSHで接続するための作業場所です。このworkspaceではサーバープロセスは動作していません
  - 実務では、このように特定のサーバーへのアクセス元が限定されていることがあるため、それを模しています
- ベースマシンからSSHでログインして利用します
- Linuxディストリビューションは Alma Linux9 です
- セキュリティの都合上、このマシンからはインターネットには繋がりません。ソフトウェアのインストールは出来ないのでご注意ください
#### 4) アプリケーションサーバー（app）
- アプリケーションロジックの動作するサーバーです。Apache Web Server 内でPythonによるビジネスロジックが動作しています
- 通常はworkspaceからSSHでログインします。しかし、ベースマシンからコンソール接続（IPアドレスを使わない接続）も可能です
- Linuxディストリビューションは Alma Linux9 です
- セキュリティの都合上、このマシンからはインターネットには繋がりません。ソフトウェアのインストールは出来ないのでご注意ください
#### 5) データベースサーバー（db）
- データベースサーバーです。appの利用するデータが格納されています。MariaDBが動作しています
- 通常はworkspaceからSSHでログインします。しかし、ベースマシンからコンソール接続（IPアドレスを使わない接続）も可能です
- Linuxディストリビューションは Alma Linux9 です
- セキュリティの都合上、このマシンからはインターネットには繋がりません。ソフトウェアのインストールは出来ないのでご注意ください
#### 6) Webサーバー（web）
- インターネットとの出入り口になるWebサーバーで、Nginxで動作しています
- Webサイトの利用者（受講者PC）からのブラウザアクセスは、このWebサーバーを経由してappに繋がります
- 後述の監視サーバーへの接続と、ユーザー認証も担当しています
- このサーバープロセスは、ベースマシン上で動作しています
#### 7) 監視サーバー（netdata）
- Webサイトのリソース監視を行うサーバーです。Netdataというオープンソースの製品を使っています
- このサーバープロセスはベースマでン上で動作しています
- 受講者PCのブラウザからログインできます。通常のポート番号とは異なるので注意しましょう
#### 8) Apache Guacamole（わかもれ）
- 演習環境に入るための踏み台サーバーです。演習中は特に意識する必要はありません

### 2. 各サーバーの情報確認
#### IPアドレス、ホスト名の確認
- 上記で紹介したサーバーのIPアドレスやホスト名を構成図上で確認しましょう。必要になるたびに構成図を参照してもよいですし、メモ帳などにまとめて控えておいても構いません。頻繁に必要になるはずなので、扱いやすい方法を自分で考えましょう
- appサーバー、dbサーバー、workspaceサーバーの情報は、「ベースマシン」上で以下のコマンドを実行することでも確認できます
```
lxc list
```
  - 以下は、実行例です。本演習ではIPv6は使用しないため、気にしなくて構いません
 ```
ec2-user@ip-10-0-131-89:~ -THISISNOTWORKSPACE- $ lxc list
+-----------+---------+----------------------+----------------------------------------------+-----------+-----------+
|   NAME    |  STATE  |         IPV4         |                     IPV6                     |   TYPE    | SNAPSHOTS |
+-----------+---------+----------------------+----------------------------------------------+-----------+-----------+
| app       | RUNNING | 10.87.227.78 (eth0)  | fd42:999d:228:3ae0:216:3eff:fe44:efaa (eth0) | CONTAINER | 0         |
+-----------+---------+----------------------+----------------------------------------------+-----------+-----------+
| db        | RUNNING | 10.87.227.141 (eth0) | fd42:999d:228:3ae0:216:3eff:fefc:d2e4 (eth0) | CONTAINER | 0         |
+-----------+---------+----------------------+----------------------------------------------+-----------+-----------+
| workspace | RUNNING | 10.87.227.167 (eth0) | fd42:999d:228:3ae0:216:3eff:fe45:5cae (eth0) | CONTAINER | 0         |
+-----------+---------+----------------------+----------------------------------------------+-----------+-----------+
 ```
- 各サーバーには、ログイン時に認証情報が必要になります。認証情報は、user1/password といった形で構成図に記載があるのでよく確認しておきましょう

::: danger
演習のため、認証情報には非常に簡単なものを使っています。実務では、現場のセキュリティルールに従った強力な認証情報を使ってください
:::

- なお、各サーバー間でのpingは通じないことがあります。正常性確認のタイミングで、pingが通じるかどうかを確認しておくと、後で慌てずに済むかもしれません

### 3. workspaceへのログイン
- appサーバーやdbサーバーにログインするには、workspaceを介する必要があります。「ベースマシン」で以下のコマンドを実行し、workspaceにログインしましょう
```
ssh user1@workspace
```
- 認証情報は構成図から確認してください。上記コマンドにある「user1」の意味も理解しておきましょう
- 確認が終わったらログアウトして、ベースマシンに戻ってください。この一連の作業で、ベースマシンやworkspaceのプロンプトを把握しておいてください
  - 今後は、自分がどのサーバーで作業しているのかを必ず把握し、作業対象を間違えないようにしてください。作業対象の間違いは、実務でもよく起こるミスです
### 4. 正常性確認
- トラブルを発生させる前に、Webサイトの正常性を確認しておきます。以下を順番に実施し、Webサイトの正常稼働状態を把握しておきましょう
#### Webサイト情報の把握
- ベースマシンのホームディレクトリには、`get-public-hostname.sh`というシェルスクリプトがあります。これを実行してインターネットからの接続情報などを把握しておきましょう
- 以下は実行結果のサンプルです（受講者ごとに以下の情報は異なります）
```
ec2-user@ip-10-0-131-89:~ -THISISNOTWORKSPACE- $ ./get-public-hostname.sh
--- your informations ---

your public internet hostname
ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.com

your website
ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.com/myapp/

your monitoring dashboard
ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.com:9999
username: user1
password: password

your private address
10.0.131.89
```
- 出力結果の意味は以下の通りです
##### your public internet hostname
- ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.comは、インターネットから見たときのベースマシンのホスト名です
##### your website
- ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.com/myapp/は、今回トラブルの発生するWebサイトのURLです
- ブラウザからアクセスできるので、正常にWebサイトが表示されることを確認しておきましょう
  - 表示されるとご認識頂けると思いますが、このWebサイトは以前に「Linux個人演習」で構築頂いたものと同じです（ただしサーバー構成は異なります）

::: warning
うまく表示されない場合、http:// でアクセスしているかを確認してください。まれに、ブラウザ貼り付け時に https:// になってしまっていることがあります。httpsではアクセスできません
:::

##### your monitoring dashboard
- ec2-43-206-91-184.ap-northeast-1.compute.amazonaws.com:9999は、監視サーバーです。ブラウザからアクセスできます
  - your public internet hostname にポート番号9999が追加されているだけです
- アクセスすると、ブラウザに「ログイン」というダイアログが出てくるので、以下の情報を入力してログインしてください
```
ユーザー名:  user1
パスワード:  password
```
- ログインが成功すると、Netdataのトップページが表示されます。パスワードの保存はしてもしなくても構いません
- 表示されたページの右下に **Skip and use the dashboard anonymously.** という緑の文字があるので、そちらをクリックすると監視ダッシュボードが表示されます

::: warning
緑の SignIn ボタンは押さないでください
:::

- 監視状況がリアルタイムに更新されているはずです。もしされていない場合は左上の灰色の「Pausing」ボタンを押し、表示を「Playing」に変えればよいです

##### your private address
- 10.0.131.89 は、ベースマシンのプライベートIPアドレスです。通常は意識する必要はありませんが、講師から提示を求められたら受講者名とともに伝えてください。なお、`ip a`など通常のコマンドでも同じものが確認できます

#### 各ホストへのログイン
- 作業対象となる各ホストへのログインも実施してください
- まずはworkspaceにログインします。その後、以下のコマンドでappサーバーやdbサーバーにログインしてください
  - appサーバーにログインしたい場合 `ssh app`
  - dbサーバーにログインしたい場合 `ssh db`

- sshコマンドの実行時に以下のようなメッセージが出ることがあります。これはSSHでの初回接続時のセキュリティ機能です。この演習では yes を入力して先に進んでください
```
The authenticity of host 'db (fd42:999d:228:3ae0:216:3eff:fefc:d2e4)' can't be established.
ED25519 key fingerprint is SHA256:TaO2Zk5ta59gteofq2Nj5gxl7OoGrnUVOA3ztAFCtMs.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```
- appでサーバーでは`httpd`サービスが、dbサーバーでは`mariadb`サービスが起動しています。`systemctl`を使って、動作状況を確認しておきましょう。どんなコマンドを実行すれば良いかは、これまでの研修を思い出してください
- 各ホストでの正常性確認が終わったら、ベースマシンに戻っておいてください（コマンドプロンプトを見てベースマシンであることを認識してください）

### 5. 初期化処理（init.shの実行）
- 現状把握が全て終わったら、初期化処理をします

::: danger
init.shの実行タイミングは、講師から指示があります。必ず講師の指示に従ってください
:::

- ホームディレクトリの`init.sh` を実行してください。スクリプトの実行方法は「実務で使えるLinux 入門編」で取り上げていますので、思い出しましょう
- 実行には少し時間がかかるかもしれません。プロンプトが表示されれば、実行は終了です

### （オプション）動画視聴
- 現状把握が早く終わった方は、第3章の動画を視聴しましょう
  - 視聴しなくとも演習には影響ありません

## IV. トラブルシューティングの実践
- 講師からの操作により、全受講者の演習環境にトラブルが発生します
- ここから先は、これまでの学習内容を駆使して手探りでのトラブルシューティングが始まります
- 起きているトラブルは一つとは限りません。また、あるトラブルを解決するためには先に別のトラブルを解決しないといけないかもしれません。仮説を立て、コマンドを実行して仮説を確認・実証し、修正しながら進めてください
- 研修システムのスケジュール通りに時間を区切りながら、時間内のトラブル解決を目指しましょう

### 1. 状況確認
- WebサイトのURLにアクセスし、Webサイトが表示されなくなっていることを確認しましょう。ブラウザのリロードでも、新たにURLを貼り直しても、どちらでも構いません
- この時点で、監視サーバーへのアクセスも出来なくなっています。構成図をよく見て、なぜそうなっているのかを考えましょう
- トラブル発生時時でわかっているのは、上記2点だけです。構成図や現状把握で取得した情報を元に、Webサイトを復旧してください
### 2. はじめの一歩
- トラブルシューティングはどこから始めても構いませんが、最初のうちは手がかりが少なく何から始めていいかわかりづらいかもしれません。ブラウザに表示されているエラーメッセージから判断して行動を起こしてください
- app/dbの各サーバーにも何か起きているかもしれません。workspaceを経由してログインし、状況を確認してください
### 3. 必要になるコマンドについての補足
- トラブルシューティングに必要な知識や技術は、これまでの研修で得られていますが、一部今回の演習環境に独特な使用やこれまでの研修で明確に取り上げていないコマンドを使用することがあるので、以下に補足をします
#### appサーバーやdbサーバーへの、SSHを使わないログイン
- トラブルシュートを進めていくとappサーバーやdbサーバーへのログインが必要になると思いますが、SSHでのログイができなくなっているかもしれません。その場合は、「ベースマシン」から以下のコマンドでログインでききます。認証情報は不要です
```
lxc exec app bash
```
```
lxc exec db bash
```
- ログインした後の操作はworkspaceからSSHでログインしたときと同じですが、rootユーザーでのログインになっていることに注意してください

#### ネットワークインターフェース (NIC) のリンクアップについて
- トラブルの原因の一つにサーバーのネットワークのリンクダウンが考えられる場合は、以下のコマンドで指定したNICをリンクアップできます
```
ip link set eth0 up 
```

### 4. トラブルシューティングのヒント
- 以下には、作業時のヒントを記載しています。チャレンジを楽しみたい方は、見ずに進めても構いません
#### サーバーを起動できないときは
- サーバーを起動するコマンドを実行したにも関わらず起動ができないときは、エラーメッセージが必ずどこかに記載されています。エラーの記載されるファイルであるエラーログファイルの場所は、製品によって異なります。これまでの研修で取り上げたファイル検索コマンドやネットの情報などを駆使して、エラーメッセージを探し対応してください

  ::: details ヒント 
  一般的に Red Hat系のディストリビューションでは、OSの動作に関するログは /var/log/messages にあります。また、MariaDBなど製品のログは、同じく/var/logディレクトリ内にあることが多いです
  :::

#### 全て復旧したはずなのにブラウザからアクセスできない
- 全てのトラブルを解決したはずなのにブラウザからWebサイトにアクセス出来ない、という事態になるかもしれません。その時は、構成図をもう一度よく見直し、対応を忘れている要素がないかを確認してください
- appサーバー内で以下のコマンドを実行してWebサイトのコンテンツが表示されたら、Webサイト自体は問題なく稼働しています。復旧できていない要素がまだ残っているということです。構成図をよく見ながら、トラブルシューティングを再開しましょう
```
curl http://localhost/myapp/
```
- ブラウザに表示されているエラーメッセージもよく確認しましょう

#### 設定変更は、一度に多くを実施しない
- サーバーの設定を変えた方がいいと思ったら、変えましょう。ただし、一度に複数箇所を変更するのはお勧めしません。一度に変更する箇所は一つにし、調査の分岐点を多く作らないようにしましょう

### 5. 復旧の報告前に
- 受講者PCのブラウザからWebサイトと監視サーバーへのアクセスが出来るようになったら、トラブルは一旦解決しています
- 同じトラブルが再発しないかを確認するために、「ベースマシン」で以下のコマンドを実行してapサーバーとdbサーバーをリブートしてください
```
lxc restart app
```
```
lxc restart db
```
- 状況を確認し、トラブルが起きているようであれば原因を調査して修復してください
- ここまで完了すれば、トラブルシューティング作業は完了です。

---

## V. 障害報告書の作成
- トラブルシューティングが終わったら、障害報告書を作成します。以下の項目を含めてください
- 障害報告書には、再発防止策を含める必要があります。今回は演習なので書けることは限られてきますが、同じトラブルを起こさないように取れる対策を考えてください
- 記載内容の検討にあたり、インターネットの情報を検索するのは構いません
- 生成AIサービスの活用は構いませんが、報告書の作成に利用することは禁止します
#### 報告書のタイトル
-  （例）「弊社Webサイトにおける障害報告書」
#### 概要
- どんなトラブルがいつ発生していつ解決したかを簡潔に記載します
- 詳細はこれから記載するので、ここでは不要です
#### 発生日時と復旧日時
- トラブルの発生が確認された日時と、復旧確認の報告をした時間を記載してください
- 書式はお任せしますが、わかりやすく記載しましょう
#### 影響範囲
- 今回のトラブルの影響範囲を記載します。ただ今回は演習のため、簡単な表現で構いません
#### 経緯
- 今回の事象の発発から解決までを、時系列で記載してください。何時何分、何が起こったか、何をしたか、ということを記載します
- （例）2025年8月5日午前11時 Webサイトへのアクセスができないとお客様から多数報告あり
#### 原因
- 複数の原因があったと思います。わかりやすく箇条書きで記載してください
#### 対処内容と施した再発防止策
- それぞれの原因に対し、どういう設定や作業を行ってトラブルシュートをしたかを記載します
- また、同じトラブルが再度発生しないようにどのような対策を取ったかも記載します
## 演習終了
- 以上で演習は終了です。お疲れ様でした。日報では、今日の1日を振り返りましょう

---
## - Appendix -
- 以下はより詳細な解説であり、演習の遂行には不要です。演習が早く終わった場合やより詳細を知りたい方はご確認ください
## 構成詳細
![](./linuxintro-tshoot-structure-student-detail.drawio.svg)
### サーバー構成について
- アプリケーションサーバーやデータベースサーバーは、実務の環境に似せるためにそれぞれ別のホストとして構成しています
- ただし今回の演習環境であるAmaon Web Services(AWS)では、VM内でのVMの起動（NestedVM）が仕様上構成できないため、LXCコンテナを使用しました
- LXCはLinux Container という機能で、Linuxでのコンテナ型仮想化の仕組みです。古くから軽量VMとして利用されてきました
  - コンテナソリューションとして有名なDockerは、でで初期バージョでは中核部分にLXCを使用していました
- LXCはDockerと異なりsystemdを動作させることができるので、通常のVMとほぼ変わらない使い勝手を実現します。まさに今回のような用途にはうってつけです
### ネットワーク構成について
- ベースマシンで稼働しているNginxは、apサーバーへのリバースプロキシおよびNetdataの認証サーバーとして機能しています
  - LXCコンテナは、デフォルトではコンテナ外部からの通信は受け付けません
- LXCコンテナへのパケット転送は、LXCの設定でも可能なのですが、設定が複雑になるのと演習内容以外での予備知識が必要になるため今回は利用しませんでした
- Netdataは、インターネットからの直アクセスになるためユーザー認証を設けています。ちなみにポート番号もデフォルトの19999から9999へ変更しています
- 上記の設定は、ベースマシンのNginxのコンフィグを見ると確認できるので、興味のある方はチェックしてみてください
- NetdataはDockerで動作しています。興味のある方はDockerコマンドを使って操作してみましょう
### LXCのコマンドについて
- 演習中に実行した`lxc exec`は、LXCコンテナ内でコマンドを実行するコマンドです。例えば`lxc exec db bash`は、dbコンテナ内でbashを実行する、つまりdbコンテナに入りシェルを操作する、ということを意味しています。他にも`lxc exec db -- ls /`と実行すると、dbコンテナのルートディレクトリの一覧を表示できます。時間があればいろいろ試してみてください

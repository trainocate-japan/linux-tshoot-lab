(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{328:function(a,t,s){a.exports=s.p+"assets/img/linuxintro-tshoot-structure-instructor.drawio.5e38a204.svg"},339:function(a,t,s){"use strict";s.r(t);var e=s(27),r=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"講師向けガイド"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#講師向けガイド"}},[a._v("#")]),a._v(" 講師向けガイド")]),a._v(" "),t("h6",{attrs:{id:"v25-08-04-01"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#v25-08-04-01"}},[a._v("#")]),a._v(" v25.08.04.01")]),a._v(" "),t("ul",[t("li",[a._v("この資料やシェルスクリプトなどのソースコードは "),t("a",{attrs:{href:"https://github.com/trainocate-japan/linux-tshoot-lab",target:"_blank",rel:"noopener noreferrer"}},[a._v("github:linux-tshoot-lab"),t("OutboundLink")],1),a._v(" で管理しており、講師用マシンのホームディレクトリにclone済みです")]),a._v(" "),t("li",[a._v("スクリプトなどが追加されることがあるので、ログイン時にgit pull してもらうとよいと思います")])]),a._v(" "),t("h2",{attrs:{id:"コース概要"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#コース概要"}},[a._v("#")]),a._v(" コース概要")]),a._v(" "),t("ul",[t("li",[a._v("Linuxで稼働しているシステムに発生するシステムトラブルの種類や対応できるコマンドの紹介や、システムトラブル対応の基礎を学ぶコースです")]),a._v(" "),t("li",[a._v("コースは2日構成です。1日目はトラブル対応に関連する知識を学ぶ座学で、2日目はトラブル解決を実践する演習を行います")]),a._v(" "),t("li",[a._v("発生するトラブルのほとんどは実務で使えるLinux 入門編」を学んでいれば解決できる内容です（速習Linuxでも構いません）\n"),t("ul",[t("li",[a._v("一部、自己で検索が必要なトラブルも含まれます")]),a._v(" "),t("li",[a._v("前提のコースで取り上げてないことは全て受講者向け資料で補足します")])])])]),a._v(" "),t("h2",{attrs:{id:"演習概要"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#演習概要"}},[a._v("#")]),a._v(" 演習概要")]),a._v(" "),t("ul",[t("li",[a._v("Red Hat系Linuxで稼動するWebシステムに発生したトラブルを解決し、システムの復旧作業を実践します")]),a._v(" "),t("li",[a._v("webアプリケーションサーバーとDBサーバーに発生した複数のトラブルを修復する作業を通じて、実際の現場でのトラブル対応に近い体験ができます")]),a._v(" "),t("li",[a._v("演習での復旧作業のまとめとして、障害報告書を作成する時間を2日目の最後にとります")])]),a._v(" "),t("h2",{attrs:{id:"構成図"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#構成図"}},[a._v("#")]),a._v(" 構成図")]),a._v(" "),t("p",[t("img",{attrs:{src:s(328),alt:"構成図"}})]),a._v(" "),t("h3",{attrs:{id:"構成図解説"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#構成図解説"}},[a._v("#")]),a._v(" 構成図解説")]),a._v(" "),t("blockquote",[t("p",[a._v("わかもれなど、環境への接続については省略しています")])]),a._v(" "),t("ul",[t("li",[a._v("1台のAWS EC2インスタンス(base-machie:Ubuntu) に、2台のホストからなるWebシステムを構成しています（構成構上の黄色箇所）")]),a._v(" "),t("li",[a._v("Webシステムの他、作業端末用にもう一台ホストがあります（構成図右側の青塗りつぶし箇所）")]),a._v(" "),t("li",[a._v("インスタンス内の各ホストはLXCコンテナで実現しています\n"),t("ul",[t("li",[a._v("EC2インスタンスはNestedVMに対応していないため、LXCコンテナを採用しました")])])]),a._v(" "),t("li",[a._v("LXCコンテナ内のOSはAlmaLinux9です。今後変更の可能性はあります")]),a._v(" "),t("li",[a._v("インスタンス内コンテナのネットワークアドレスは、受講者ごとに異なる可能性があります")]),a._v(" "),t("li",[a._v("構成図上の左側にあるNginx（ねずみ色箇所）はリバースプロキシとして稼動させています。詳細は後述します")]),a._v(" "),t("li",[a._v("受講者向け構成図は、LXCコンテナなどを省いた簡略版（演習に必要な情報のみ）を展開します。ただし、興味のある受講者向けに詳細構成図やLXCの解説などを付録として記載する予定です")])]),a._v(" "),t("h3",{attrs:{id:"構成詳細"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#構成詳細"}},[a._v("#")]),a._v(" 構成詳細")]),a._v(" "),t("ul",[t("li",[a._v("ログインのための認証情報は構成図に記載があります")]),a._v(" "),t("li",[a._v("ログインはlxcコマンドを使ったログイン（コンソール接続のような感じ）のほか、通常のSSHも可能です")])]),a._v(" "),t("h4",{attrs:{id:"base-machine"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#base-machine"}},[a._v("#")]),a._v(" Base-Machine")]),a._v(" "),t("ul",[t("li",[a._v("Ubuntu 24.02")]),a._v(" "),t("li",[a._v("演習環境のベースとなるホストです。Ubuntuを採用した意図としては、LXCが使いやすいことと、作業環境ではないことをすぐに気づけるようにするためです")]),a._v(" "),t("li",[a._v("Base-Machine上では、Nginxの復旧を除きトラブルシューティング作業は行いません")]),a._v(" "),t("li",[a._v("Ubuntuのシェルを使っていることが分かるように、シェルのプロンプトを変更しています")]),a._v(" "),t("li",[a._v("わかもれから受講者マシンと同じ方法でログインするほか、AWSマネコンからSessionManagerでも接続できます")])]),a._v(" "),t("h4",{attrs:{id:"appコンテナ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#appコンテナ"}},[a._v("#")]),a._v(" appコンテナ")]),a._v(" "),t("ul",[t("li",[a._v("Alma Linux 9")]),a._v(" "),t("li",[a._v("Apache HTTP Serverが稼働")]),a._v(" "),t("li",[a._v("Linux個人演習のWebアプリを流用")]),a._v(" "),t("li",[a._v("後述のNginxをWebサーバーとしているため、appサーバーと名前を変えてますがあまり意味はありません")]),a._v(" "),t("li",[a._v("base-machineから、"),t("code",[a._v("lxc exec app bash")]),a._v(" でログインできます")])]),a._v(" "),t("h4",{attrs:{id:"dbコンテナ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dbコンテナ"}},[a._v("#")]),a._v(" dbコンテナ")]),a._v(" "),t("ul",[t("li",[a._v("Alma Linux 9")]),a._v(" "),t("li",[a._v("MariaDB")]),a._v(" "),t("li",[a._v("Linux個人演習のWebアプリを流用")]),a._v(" "),t("li",[a._v("base-machineから、"),t("code",[a._v("lxc exec db bash")]),a._v(" でログインできます")])]),a._v(" "),t("h4",{attrs:{id:"作業端末"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作業端末"}},[a._v("#")]),a._v(" 作業端末")]),a._v(" "),t("ul",[t("li",[a._v("Alma Linux 9")]),a._v(" "),t("li",[a._v("受講者はUbuntuからこちらにログインし、トラブルシュート作業を行う")]),a._v(" "),t("li",[a._v("base-machineから、"),t("code",[a._v("lxc exec workspace bash")]),a._v(" でログインできます")])]),a._v(" "),t("h4",{attrs:{id:"nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[a._v("#")]),a._v(" nginx")]),a._v(" "),t("ul",[t("li",[a._v("Ubuntu上で直接稼働するサービス")]),a._v(" "),t("li",[a._v("Webサーバーにインスタンス外部からの接続をルーティングするために使用")]),a._v(" "),t("li",[a._v("もう一つ、netdata（負荷計測用。後述）のユーザー認証のためにも使用しています\n"),t("ul",[t("li",[a._v("インターネットにポートを開放しているため、Basic認証をかけるためです")])])])]),a._v(" "),t("h4",{attrs:{id:"netdata"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netdata"}},[a._v("#")]),a._v(" Netdata")]),a._v(" "),t("ul",[t("li",[a._v("UbuntuやLXCコンテナの負荷計測用に、Netdataというオープンソースの監視ソフトウェアをUbuntu上で動作させています\n"),t("ul",[t("li",[a._v("Dockerを使っていますが、受講者はそれを意識する必要はありません")])])]),a._v(" "),t("li",[a._v("Netdataで情報を見るためにはBasic認証をする必要があります。認証情報は構成図に記載してあります（user1/password）")]),a._v(" "),t("li",[a._v("今回は負荷系のトラブルはありませんが、監視ダッシュボードを見るのはトラブルシュート時に必須な作業のために設置してます")])]),a._v(" "),t("h2",{attrs:{id:"発生するトラブルについて"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#発生するトラブルについて"}},[a._v("#")]),a._v(" 発生するトラブルについて")]),a._v(" "),t("h3",{attrs:{id:"appコンテナ-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#appコンテナ-2"}},[a._v("#")]),a._v(" appコンテナ")]),a._v(" "),t("h4",{attrs:{id:"apacheサービスを停止"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#apacheサービスを停止"}},[a._v("#")]),a._v(" Apacheサービスを停止")]),a._v(" "),t("ul",[t("li",[a._v("stopするだけなので、systemctl startで復旧できます")])]),a._v(" "),t("h4",{attrs:{id:"etc-httpd-conf-httpd-confのdocumentrootがシンタックスエラー"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#etc-httpd-conf-httpd-confのdocumentrootがシンタックスエラー"}},[a._v("#")]),a._v(" /etc/httpd/conf/httpd.confのDocumentrootがシンタックスエラー")]),a._v(" "),t("ul",[t("li",[a._v("/var/log/mariadb/mariadb.logを閲覧すればシンタックスエラーが出ているので気づけるはずです")])]),a._v(" "),t("h4",{attrs:{id:"systemctl-enable-されておらず、自動起動しない"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#systemctl-enable-されておらず、自動起動しない"}},[a._v("#")]),a._v(" systemctl enable されておらず、自動起動しない")]),a._v(" "),t("ul",[t("li",[a._v("復旧確認後に動作確認としてコンテナをリブートするように指示するので、そこで再び障害となります。もちろんすでに修正済みの場合は何も起きません")])]),a._v(" "),t("h3",{attrs:{id:"mariadbコンテナ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mariadbコンテナ"}},[a._v("#")]),a._v(" MariaDBコンテナ")]),a._v(" "),t("h4",{attrs:{id:"mariadbサービス"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mariadbサービス"}},[a._v("#")]),a._v(" MariaDBサービス")]),a._v(" "),t("ul",[t("li",[a._v("stopするだけなので、systemctl startで復旧できます")])]),a._v(" "),t("h4",{attrs:{id:"ip-link-set-eth0-down-を実行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ip-link-set-eth0-down-を実行"}},[a._v("#")]),a._v(" ip link set eth0 down を実行")]),a._v(" "),t("ul",[t("li",[a._v("リンクダウン障害を起こします。これとストレージ問題を解決しないとMariaDBは起動できません")]),a._v(" "),t("li",[a._v("DBコンテナにSSHログインできなくなるため 、コンソールログイン用のLXCコマンドが必要になります。 リンクダウン障害や復旧方法も含めて、受講者向けのWeb資料にヒントとして記載します")]),a._v(" "),t("li",[a._v("このトラブルは受講者ホストに入っている init.sh で実行されます（講師からはででコントロできません）")])]),a._v(" "),t("h4",{attrs:{id:"ストレージの消費量が100-になっている"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ストレージの消費量が100-になっている"}},[a._v("#")]),a._v(" ストレージの消費量が100%になっている")]),a._v(" "),t("ul",[t("li",[a._v("ddコマンドで無駄なファイルを生成しストレージの残りが0%になっており、MariaDBのstartができなくなってます")]),a._v(" "),t("li",[a._v("/var/log/mariadb/mariadb.logを閲覧すればストレージ不足のエラーが出ているので気づけるはずです")]),a._v(" "),t("li",[a._v("無駄なファイルがどこにあるかを探すコマンドは受講者ガイドにヒントとして記載します")]),a._v(" "),t("li",[a._v("このトラブルは受講者ホストに入っている init.sh で実行されます（講師からは実行しません）")])]),a._v(" "),t("h3",{attrs:{id:"nginxサービス-base-machine"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginxサービス-base-machine"}},[a._v("#")]),a._v(" Nginxサービス（base-machine）")]),a._v(" "),t("ul",[t("li",[a._v("appサーバーまでは復旧して内部的にwebページを参照できるがインターネットからは見れない、という状態です。復旧確認として、Ubuntuからページを見るためのcurlコマンドを受講者向けガイドには記載します\n"),t("ul",[t("li",[a._v("Ubuntu上でコマンドを発行することになりますがsystemctlだけなので実施できると想定しています")])])]),a._v(" "),t("li",[a._v("Nginxが落ちている間はブラウザアクセスができないので、Netdataへのアクセスも出来ないはずです。なので、appコンテナのCPU高騰に気づくのはこのタイミングだと思います")])]),a._v(" "),t("h2",{attrs:{id:"講師用端末について"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#講師用端末について"}},[a._v("#")]),a._v(" 講師用端末について")]),a._v(" "),t("ul",[t("li",[a._v("トラブル発生の捜査や、受講者Weサイトの復旧を確認するための講師用端末を用意しています。演習中はログインしておいてください")]),a._v(" "),t("li",[a._v("ログイン方法は受講者同様、わかもれです。わかもれの認証情報は別途展開しています。わかもれのあとは、受講者と同じ、ec2-user/passwordでログインできます")]),a._v(" "),t("li",[a._v("以下に詳細を記載します")])]),a._v(" "),t("h3",{attrs:{id:"linux-tshoot-instructor-machine-講師用端末・構成図外"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux-tshoot-instructor-machine-講師用端末・構成図外"}},[a._v("#")]),a._v(" linux-tshoot-instructor-machine（講師用端末・構成図外）")]),a._v(" "),t("ul",[t("li",[a._v("SessionManagerでログイン後、su - ec2-user (pasword)")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[ec2-user@ip-10-0-128-136 ~]$ tree -L 1 linux-tshoot-lab/lab/bin/instructor-machine/\nlinux-tshoot-lab/lab/bin/instructor-machine/\n├── cheker.sh\n├── public-address-getter.sh\n├── reboot-instance.sh\n├── repaierman-on-instructor-machine.sh\n└── trouble-maker-on-instructor-machine.sh\n")])])]),t("ul",[t("li",[a._v("主要なファイルはホームディレクトリにコピーしてますが、新規に追加されたスクリプトなどはやってないかも、、、です")]),a._v(" "),t("li",[a._v("スクリプトに実行権限つけるとgit pull時に差分でできないかもしれないのでご注意を、、、（git config core.filemode falseはやってません）")])]),a._v(" "),t("h4",{attrs:{id:"外形監視-受講者weサイトの状態確認"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#外形監視-受講者weサイトの状態確認"}},[a._v("#")]),a._v(" 外形監視（受講者Weサイトの状態確認）")]),a._v(" "),t("ul",[t("li",[a._v("public-address-getter.sh で、受講者WebサイトのURLを urls.csvに保存します")]),a._v(" "),t("li",[a._v("checker.sh urls.csv を実行すると、受講者Webサイトの接続可否が表示されます")])]),a._v(" "),t("h4",{attrs:{id:"トラブル発生と修復"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#トラブル発生と修復"}},[a._v("#")]),a._v(" トラブル発生と修復")]),a._v(" "),t("ul",[t("li",[a._v("Amazon SSM のRunCommandを使って受講者ホストにトラブルを起こします")]),a._v(" "),t("li",[a._v("trouble-maker-on-instructor-machine.sh で、受講者環境にトラブルを発生させます。DBコンテナのストレージ圧迫とNICダウンは自動化するとまれに実施できないインスタンスがあるため、受講者ホストにあるinit.shに分離し、受講者自身に実施してもらうことにしてます\n"),t("ul",[t("li",[a._v("実行後にCommandIDが表示されるので、進捗確認にお使いください")])])]),a._v(" "),t("li",[a._v("repaierman-on-instructor-machine.shを実行すると全受講者のWebサイトが復旧します")])]),a._v(" "),t("h4",{attrs:{id:"受講者インスタンスのリブート"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#受講者インスタンスのリブート"}},[a._v("#")]),a._v(" 受講者インスタンスのリブート")]),a._v(" "),t("ul",[t("li",[a._v("reboot-instance.sh の引数に対象のプライベートアドレスを渡して実行するとインスタンスをリブートします")]),a._v(" "),t("li",[a._v("予備機を払い出す前にリブートを試してみても良いかもしれません")])]),a._v(" "),t("h2",{attrs:{id:"トラブルの発生方法について"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#トラブルの発生方法について"}},[a._v("#")]),a._v(" トラブルの発生方法について")]),a._v(" "),t("ul",[t("li",[a._v("2段階に分かれています。流れは後述の「コースの進め方」を参考にしてください")])]),a._v(" "),t("ol",[t("li",[a._v("AWSの運用サービスであるSSM RunCommandを使って、インスタンスの外部から以下のシェルスクリプトを注入して実行します")])]),a._v(" "),t("ul",[t("li",[a._v("講師用端末にスクリプトを配置するので、AWSコンソールへのログインは不要です")]),a._v(" "),t("li",[a._v("trouble-maker-on-instructor-machine.sh")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/sh")]),a._v("\naws ssm send-command "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --document-name "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"AWS-RunShellScript"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--region")]),a._v(" ap-northeast-1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--targets")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Key")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("resource-groups:Name,Values"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("linux-tshoot-targets "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--parameters")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("commands")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"sudo systemctl stop nginx"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"lxc exec app -- sudo systemctl stop httpd"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"lxc exec app -- sudo systemctl disable httpd"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"lxc exec app -- sudo sed -i s/^DocumentRoot/ocumentRoot/ /etc/httpd/conf/httpd.conf"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"lxc exec db -- sudo systemctl stop mariadb"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"lxc exec db -- sudo systemctl disable mariadb"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v("jq "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'.Command.CommandId'")]),a._v("\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[a._v("base-machineのホームディレクトリにある init.sh を実行してもらいます。dbコンテナのリンクダウンとストレージ圧迫を行います")])]),a._v(" "),t("ul",[t("li",[a._v("init.sh（内部でdb.shを呼び出している）")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/sh")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" ./linux-tshoot-lab\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" clone https://github.com/trainocate-japan/linux-tshoot-lab.git\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" linux-tshoot-lab/lab/bin/db.sh\n")])])]),t("ul",[t("li",[a._v("db.sh（dbコンテナ内でストレージ圧迫とリンクダウンを発生）")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/sh")]),a._v("\nlxc "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" db -- "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("dd")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dev/random "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("of")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/log/mudana-file.img "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("1M "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("count")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3750")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),a._v(" /dev/null "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("\nlxc "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" db -- "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("link")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" eth0 down\n")])])]),t("ul",[t("li",[a._v("1と2の実行順番はどちらでも構いません。流れとしては、現状把握の最後に各自のタイミングでinit.shを実行してもらい、その後休憩明けに講師がtrouble-makerを実行する、としています\n"),t("ul",[t("li",[a._v("init.shはストレージに負荷がかかるため、一斉実行するともしかするとうまく実行できないbase-machineが出てくるかもです。その場合は予備機に変えてもらった方が無難です。予備機については後述します")])])]),a._v(" "),t("li",[a._v("ちなみに、、、ストレージ圧迫はddコマンドを利用していますが、大量のインスタンスが同時に実行するとどこかで処理が詰まるのか、失敗するインスタンスがいくつか出てきます。なので実行タイミングがばらけるように、講師からの実施ではなく受講者にタイミングを委ねることにしました")]),a._v(" "),t("li",[a._v("勘のいい受講者さんには早く気づかれるかもです。そこはまぁよしとしましょうw")])]),a._v(" "),t("h2",{attrs:{id:"コースの進め方"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#コースの進め方"}},[a._v("#")]),a._v(" コースの進め方")]),a._v(" "),t("h3",{attrs:{id:"オリエンテーション"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#オリエンテーション"}},[a._v("#")]),a._v(" オリエンテーション")]),a._v(" "),t("ul",[t("li",[a._v("30-40min")]),a._v(" "),t("li",[a._v("演習の説明")]),a._v(" "),t("li",[a._v("演習環境の解説、ログイン方法\n"),t("ul",[t("li",[a._v("以前から利用しているわかもれなので皆さん覚えているはずですが、講師からのデモがあるとよいと思います")])])]),a._v(" "),t("li",[a._v("トラブル発生タイミングのお知らせ\n"),t("ul",[t("li",[a._v("11:10の全体休憩後に、講師の手によりトラブルが発生します")])])]),a._v(" "),t("li",[a._v("質疑応答")])]),a._v(" "),t("h3",{attrs:{id:"現状把握"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#現状把握"}},[a._v("#")]),a._v(" 現状把握")]),a._v(" "),t("ul",[t("li",[a._v("20-30min")]),a._v(" "),t("li",[a._v("get-public-hostname.shを動かしてURLやプライベートアドレスを把握")]),a._v(" "),t("li",[a._v("インターネットからのアクセスを試す")]),a._v(" "),t("li",[a._v("Netdataの監視状況をメモ\n"),t("ul",[t("li",[a._v("スクリーンキャプチャでもよい")])])]),a._v(" "),t("li",[a._v("IPアドレスの記録、構成図をみながら各サーバーへのログインなどを試す")]),a._v(" "),t("li",[a._v("質疑応答\n"),t("ul",[t("li",[a._v("構成について聞かれると思います")])])]),a._v(" "),t("li",[a._v("現状把握が終わったら、各自で "),t("code",[a._v("init.sh")]),a._v(" を実行してもらいます（base-machineのホームディレクトリにあります）。初期化するように見せかけて実は、DBコンテナのストレージ圧迫とリンクダウンを行います（前述のとおり、自動化処理から行おうとするとまれに失敗することがあるためです）")]),a._v(" "),t("li",[a._v("init.sh には、実行権限がついていないので、パーミッションの変更をするか sh init.sh で実行してもらう必要があります。これは実務で使えるLinux 入門編の第3章でのの触れのですが忘れている方も多いと思いますので、必要に応じてフォローをお願いします\n"),t("ul",[t("li",[a._v("これによりinit.shの実行タイミングがズレることもちょっと期待しています")])])])]),a._v(" "),t("h3",{attrs:{id:"トラブル発生"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#トラブル発生"}},[a._v("#")]),a._v(" トラブル発生")]),a._v(" "),t("ul",[t("li",[a._v("一斉休憩後の 11:10 になったらトラブルを発生させます（init.shの実行によりすでにDBにはトラブルの起きてる方も多いと思います）")]),a._v(" "),t("li",[a._v("トラブル発生には"),t("code",[a._v("trouble-maker-on-instructor-machine.sh")]),a._v("を実行してください。進捗は"),t("code",[a._v("aws ssm list-commands --command-id コマンドID")]),a._v("でも見れますが、見にくいです。大体3分程度で終了します。なので受講者には、3分ほどの待ち時間が発生することもお伝えください。休憩前に、休憩中にトラブルが発生することを伝えて、先に実行しても良いかもしれません")]),a._v(" "),t("li",[a._v("GUIでの進捗確認は、待機しているAWS担当者に依頼してください")]),a._v(" "),t("li",[a._v("トラブルが発生すると、外形監視が全てダウンするはずです")])]),a._v(" "),t("h3",{attrs:{id:"トラブルシューティング"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#トラブルシューティング"}},[a._v("#")]),a._v(" トラブルシューティング")]),a._v(" "),t("ul",[t("li",[a._v("15:00過ぎまで")]),a._v(" "),t("li",[a._v("この間は、トラブル解決手法以外の質問には回答してください。トラブル解決の方法を答える必要はありません")]),a._v(" "),t("li",[a._v("外形監視を定期的に確認して、早く終わっている受講者がいるかをチェックしておいてください")]),a._v(" "),t("li",[a._v("受講者のわかもれアカウント・base-machineのプライベートアドレスの一覧は事前にお渡しします。受講者から問い合わせるときはプライベートアドレスを申告してもらいます。講師からは、そのアドレスに対して ec2-user/password でsshログインができます。基本的にログインする必要はありませんが、init.shの失敗の確認時には必要になるかも知れません")])]),a._v(" "),t("h4",{attrs:{id:"復旧完了連絡の対応"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#復旧完了連絡の対応"}},[a._v("#")]),a._v(" 復旧完了連絡の対応")]),a._v(" "),t("ul",[t("li",[a._v("トラブルが解決したら講師に連絡することになっています。受講者から連絡があったら、以下を確認してください\n"),t("ul",[t("li",[a._v("受講者ホストのURL監視が復旧していること")]),a._v(" "),t("li",[a._v("報告前に、lxc resart app/dbサーバーをリブートしたかどうか")])])]),a._v(" "),t("li",[a._v("トラブルシュートが完了した受講者には、再発防止策の策定と、障害報告書の作成を指示してください。書き方は受講者資料に記載してあります")])]),a._v(" "),t("h3",{attrs:{id:"障害報告書の提出"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#障害報告書の提出"}},[a._v("#")]),a._v(" 障害報告書の提出")]),a._v(" "),t("ul",[t("li",[a._v("UMUのアンケートで提出します。これをもって演習は終了です")]),a._v(" "),t("li",[a._v("記載する内容は受講者向け資料で指示しますが、テキスト形式でのフリーフォーマットです")]),a._v(" "),t("li",[a._v("個別での評価は不要ですが、あまりに内容が薄いものやふざけているものがあれば修正を指示してください")]),a._v(" "),t("li",[a._v("書きかけで時間切れとなった場合はそこまでを提出してもらって終了です")]),a._v(" "),t("li",[a._v("URL監視や報告などで想定より早くトラブルを解決してしまった受講者には、障害報告書を書く時間を長めにとってもらってください")])]),a._v(" "),t("h3",{attrs:{id:"解説用資料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解説用資料"}},[a._v("#")]),a._v(" 解説用資料")]),a._v(" "),t("ul",[t("li",[a._v("UMUでいうと障害報告書作成のあとに、解説用のPDFを記載しています。発生していたトラブルの解説や障害報告書のサンプルなどです")]),a._v(" "),t("li",[a._v("この資料を元に解説するかは進行に応じてお任せしますが、余裕があれば16時半くらいから解説の時間を設けてもいいと思います。トラブル解消の答えも載っていますので、あまり早めの案内は避けてください")])]),a._v(" "),t("h2",{attrs:{id:"予備機について"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#予備機について"}},[a._v("#")]),a._v(" 予備機について")]),a._v(" "),t("ul",[t("li",[a._v("init.shの失敗に備えて、予備機を15台ほど用意します（yobi001-015）")]),a._v(" "),t("li",[a._v("あらかじめトラブルを起こしておきます。コンテナのアドレスなど現状把握で得られた情報はそのまま使えるはずです")]),a._v(" "),t("li",[a._v("予備機を使うかどうかの判断は、ストレージ圧迫に失敗してるかどうか、が基本です。確認方法は以下なのですが、受講者さん自身が気づいてないことが多いかもしれません\n"),t("ul",[t("li",[a._v("lxc exec db bash でログインしたあと、ログアウトができない")]),a._v(" "),t("li",[a._v("base-machine上で "),t("code",[a._v("ps aux|grep dd")]),a._v(" すると、ddコマンドでのファイル生成プロセスの状態が「D」のまま、数分進歩しない")])])]),a._v(" "),t("li",[a._v("演習がかなり進んだ後に、特にdbコンテナの動きがおかしい、という申告があったら予備機を提供してもいいと思います。それまでのトラブル対応の内容は記録するか覚えているはずなので、リカバリにそんなに時間はかからないはずです")]),a._v(" "),t("li",[a._v("トラブルシューティングのコースのため、受講者が予備機を望んだ際の状況確認は詳細に行ってください。業務で必要になる状況説明の練習にもなると思います。受講者の中には、演習のために仕込まれたトラブルなのか、本当に環境の具合が悪いのかを判断できない方もいると思います")])]),a._v(" "),t("h3",{attrs:{id:"予備機のurl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#予備機のurl"}},[a._v("#")]),a._v(" 予備機のURL")]),a._v(" "),t("ul",[t("li",[a._v("予備機は監視対象からは外しているので、もし受講者に予備機を渡した場合は urls.csv に予備機のホスト名を加えた方が良いと思います。必要に応じて予備機にログインしてURLを確認してください")])]),a._v(" "),t("h2",{attrs:{id:"その他"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#その他"}},[a._v("#")]),a._v(" その他")]),a._v(" "),t("ul",[t("li",[a._v("受講者ホストでは、ec2-user（作業用のユーザー）での sudo reboot は出来ないように制限しています。が、sudo su - でrootになったあとのリブートは制限していません。リブートしても放置すればまたわかもれからログイン出来ますので、もしリブートしてしまったという連絡があったら、3分ほどまってわかもれのログインから再開するようお伝えください\n"),t("ul",[t("li",[a._v("これは単純に制限しわすれです、、、今からVM焼き直すのが大変なので放置します、、、すみません")]),a._v(" "),t("li",[a._v("リブートしてもトラブルは解決しません（以前は解決するとお伝えしてましたがしないようにしました）")])])]),a._v(" "),t("li",[a._v("CPU使用率高騰のトラブルは今回除外しました。トラブル発生用のスクリプトからだと上手く動作しないためです。今後の課題にします")])]),a._v(" "),t("h2",{attrs:{id:"awsおよびわかもれ環境ついて"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#awsおよびわかもれ環境ついて"}},[a._v("#")]),a._v(" AWSおよびわかもれ環境ついて")]),a._v(" "),t("ul",[t("li",[a._v("以降は、主にAWSのサポートで待機しているメンバー向けの情報です。後日ちゃんと整理しますね、、、")])]),a._v(" "),t("h3",{attrs:{id:"aws上のリソース"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aws上のリソース"}},[a._v("#")]),a._v(" AWS上のリソース")]),a._v(" "),t("h4",{attrs:{id:"起動テンプレート-受講者ホスト"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#起動テンプレート-受講者ホスト"}},[a._v("#")]),a._v(" 起動テンプレート(受講者ホスト)")]),a._v(" "),t("ul",[t("li",[a._v("linux-tshoot-newtrain2025")]),a._v(" "),t("li",[a._v("ユーザーデータでnetdataコンテナの起動とinit.shの設定をしてます")])]),a._v(" "),t("h4",{attrs:{id:"講師用ホスト起動テンプレート"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#講師用ホスト起動テンプレート"}},[a._v("#")]),a._v(" 講師用ホスト起動テンプレート")]),a._v(" "),t("ul",[t("li",[a._v("linux-tshoot-newtrain2025-instructor-machine")]),a._v(" "),t("li",[a._v("AL2023にタグつけて、コースのGitリポジトリをクローンしてるだけです")]),a._v(" "),t("li",[a._v("以下、未対応なので、インスタンス入れ替え時に対応が必要\n"),t("ul",[t("li",[a._v("Ec2LinuxBasicRoleつけ忘れ")]),a._v(" "),t("li",[a._v("ec2-userのパスワード変更とSSHのパスワードログイン許可")]),a._v(" "),t("li",[a._v("git clone https://github.com/trainocate-japan/linux-tshoot-lab.git")]),a._v(" "),t("li",[a._v("講師用コマンドは、linux-tshoot-lab/lab/bin/instructor-machine/以下にある")])])])]),a._v(" "),t("h3",{attrs:{id:"わかもれ-apache-guacamole"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#わかもれ-apache-guacamole"}},[a._v("#")]),a._v(" わかもれ（Apache Guacamole）")]),a._v(" "),t("ul",[t("li",[a._v("asg guacamole-app-asg")]),a._v(" "),t("li",[a._v("rds guacamole-app-db")]),a._v(" "),t("li",[a._v("RDSへの接続情報は、上記ASGで起動するインスタンスの/opt/guacamole/docker-compose.ymlに記載してます。RDSを変えない限りは気にしなくてよいです")]),a._v(" "),t("li",[a._v("リソースグループ bastion-guacamole\n"),t("ul",[t("li",[a._v("application Insightで監視できます")])])])])])}),[],!1,null,null,null);t.default=r.exports}}]);